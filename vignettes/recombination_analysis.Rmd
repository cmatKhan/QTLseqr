---
title: "recombination_analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{recombination_analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(QTLseqr)
library(tidyverse)
library(here)
```

```{r}
c8_df = read_csv(here("temp/c8_variants.csv"))

gatk_table_path = here("temp/output.table")

col_data_path = here("temp/run_24_coldata.csv")

bsae = readRDS(here("temp/bsae_run_24_wgs.rds"))

# bsae = QTLseqr::makeBSAExperimentFromGatkTable(
#   gatk_table_path,
#   col_data_path,
#   drop_samples = c('C8', 'KN99a')
# )
# 
# SummarizedExperiment::rowRanges(bsae)$c8 = SummarizedExperiment::rowRanges(bsae) %>%
#   as_tibble() %>%
#   left_join(c8_df %>%
#               filter(parent_genotype_strict==1) %>%
#               select(CHR,POS, ALT1, c8),
#             by = c('seqnames'='CHR', 'start'='POS', 'alt'='ALT1')) %>%
#   tidyr::replace_na(list(c8=FALSE)) %>%
#   pull(c8)
# saveRDS(bsae, here("temp/bsae_run_24_wgs.rds"))
```

```{r}
chr1_sample1 = bsae[SummarizedExperiment::seqnames(bsae)==SummarizedExperiment::seqnames(bsae)@values[11], bsae@colData$sample[3]]

alt_freq = as.vector(SummarizedExperiment::assays(chr1_sample1)$AD / SummarizedExperiment::assays(chr1_sample1)$DP)

# Assume alt_freq is already defined and is a vector of alternative allele frequencies

# Step 1: Omit NAs and create a data frame to preserve original indices
na_free_alt_freq <- data.frame(
  alt_freq = na.omit(alt_freq),
  orig_index = which(!is.na(alt_freq))
)

# Step 2: Apply the rounding and filtering criteria
filtered_alt_freq <- na_free_alt_freq %>%
  mutate(
    rounded_alt_freq = case_when(
      alt_freq < 0.2 ~ 0,
      alt_freq >= 0.3 & alt_freq <= 0.7 ~ 0.5,
      alt_freq > 0.8 ~ 1,
      TRUE ~ NA_real_  # Assign NA to those that do not meet criteria
    )
  ) %>%
  filter(!is.na(rounded_alt_freq))

```

```{r}
ggplot(filtered_alt_freq, aes(orig_index, alt_freq)) +
  geom_point()

```

```{r}
ggplot(filtered_alt_freq, aes(orig_index, rounded_alt_freq)) +
  geom_point()

#bp = changepoint.np::cpt.np()
```

```{r}

get_mode <- function(v) {
  uniqv <- unique(na.omit(v))
  uniqv[which.max(tabulate(match(v, uniqv)))]
}

# Function to determine if a point is noisy based on a larger neighborhood
is_noisy <- function(freq_vector, index, neighborhood_size) {
  # Define the window range, respecting the vector boundaries
  window_start <- max(1, index - neighborhood_size)
  window_end <- min(length(freq_vector), index + neighborhood_size)
  window <- freq_vector[window_start:window_end]

  # Calculate the mode of the window
  window_mode <- get_mode(window) #modeest::mlv(window, bw = 0.5, method = 'hsm')[1]
  
  # Compare the point to the window's mode
  return(freq_vector[index] != window_mode)
}

neighborhood_size <- 20

# Apply the function to each element in the vector
noisy_flags <- sapply(1:length(filtered_alt_freq$rounded_alt_freq), function(i) {
  is_noisy(filtered_alt_freq$rounded_alt_freq, i, neighborhood_size)
})

# Remove the noisy points
x_filtered_alt_freq <- filtered_alt_freq[!noisy_flags, ]

bps = changepoint.np::cpt.np(x_filtered_alt_freq$rounded_alt_freq)

x_filtered_alt_freq %>%
ggplot(aes(orig_index, rounded_alt_freq)) +
  geom_point()

```



